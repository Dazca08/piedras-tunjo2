(window.webpackJsonp=window.webpackJsonp||[]).push([[46],{"u/OU":function(t,e,n){"use strict";n.r(e);var s=n("ofXK"),o=n("tyNb"),r=n("mrSG"),i=n("4ZJM"),a=n("AytR"),c=n("PSD3"),u=n.n(c),l=n("fXoL"),d=n("bJsm"),m=n("vDOo"),h=n("VngK"),b=n("3Pt+");function p(t,e){1&t&&(l.ac(0,"span"),l.Cc(1," El nombre de la ruta es requerido "),l.Zb())}function g(t,e){1&t&&l.Wb(0,"i",41)}function f(t,e){1&t&&l.Wb(0,"i",42)}let v=(()=>{class t{constructor(t,e,n,s){this.puntosIntService=t,this.geometryService=e,this.recorridosService=n,this.router=s,this.nombre="",this.tiempoEstimado=10,this.defineRuta=!0,this.verPtsInteres=!1,this.isPuntoInteres=!1,this.isPuntoControl=!1,this.puntosControl=[],this.existsPuntoCtrl=!1,this.markersPtsInteres=[],this.markersPtsControl=[],this.puntosInteres=[],this.ptsInteresRuta=[],this.geojson={type:"FeatureCollection",features:[{type:"Feature",geometry:{type:"LineString",coordinates:[]}}]}}ngOnInit(){}ngAfterViewInit(){i.accessToken=a.a.mapboxToken,this.mapa=new i.Map({container:"map-recorrido",style:"mapbox://styles/mapbox/streets-v11",center:[-74.3451602,4.8154681],zoom:15}),this.mapa.on("load",()=>{this.mapa.addSource("line",{type:"geojson",data:this.geojson}),this.mapa.addLayer({id:"line-animation",type:"line",source:"line",layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":"#ed6498","line-width":5,"line-opacity":.8}})}),this.mapa.on("click",t=>{const{lng:e,lat:n}=t.lngLat;this.defineRuta?this.isPuntoInteres||this.isPuntoControl?this.isPuntoInteres=this.isPuntoControl=!1:this.agregarCoordenada(e,n):this.existsPuntoCtrl||this.isPuntoInteres?this.existsPuntoCtrl=this.isPuntoInteres=!1:this.nuevoPuntoControl(e,n)}),this.mapa.addControl(new i.NavigationControl),this.mapa.addControl(new i.FullscreenControl)}nuevoPuntoControl(t,e){u.a.fire({title:"Nuevo punto de control",text:"Ingresa el nombre del punto",input:"text",showCancelButton:!0,confirmButtonText:"Agregar",cancelButtonText:"Cancelar",cancelButtonColor:"#d33",inputValidator:t=>{if(!t)return"Necesitas escribir un nombre!"}}).then(n=>{if(n.value){this.puntosControl.push({longitud:t,latitud:e,nombre:n.value});const s=new i.Popup({offset:25}).setText(n.value),o=new i.Marker({color:"#d33"}).setPopup(s).setLngLat([t,e]).addTo(this.mapa);this.markersPtsControl.push(o),o._element.addEventListener("click",()=>{this.defineRuta?(this.isPuntoControl=!0,this.agregarCoordenada(t,e)):this.existsPuntoCtrl=!0})}})}loadPuntosInteres(){return Object(r.a)(this,void 0,void 0,(function*(){this.verPtsInteres?this.puntosInteres=yield this.puntosIntService.getPuntosInteres():(this.eliminarMarkers(),this.puntosInteres=[]),this.mostrarPuntosInteres()}))}mostrarPuntosInteres(){this.puntosInteres.forEach(t=>{const e=new i.Popup({offset:25}).setText(t.Descripcion),n=(new i.Marker).setPopup(e).setLngLat([t.Longitud,t.Latitud]).addTo(this.mapa);this.markersPtsInteres.push(n),n._element.addEventListener("click",()=>{this.defineRuta&&this.agregarCoordenada(t.Longitud,t.Latitud),this.isPuntoInteres=!0})})}eliminarMarkers(){this.markersPtsInteres.forEach((t,e)=>{this.markersPtsInteres[e].remove()})}agregarCoordenada(t,e){this.geojson.features[0].geometry.coordinates.push([Number(t),Number(e)]),this.mapa.getSource("line").setData(this.geojson),this.buscarIdsPuntosInteres()}limpiar(){this.defineRuta?(this.geojson.features[0].geometry.coordinates=[],this.ptsInteresRuta=[],this.mapa.getSource("line").setData(this.geojson)):(this.puntosControl=[],this.markersPtsControl.forEach((t,e)=>{this.markersPtsControl[e].remove()}),this.markersPtsControl=[])}deshacer(){this.defineRuta?(this.geojson.features[0].geometry.coordinates.pop(),this.mapa.getSource("line").setData(this.geojson),this.buscarIdsPuntosInteres()):(this.puntosControl.pop(),this.markersPtsControl.length>0&&this.markersPtsControl[this.markersPtsControl.length-1].remove(),this.markersPtsControl.pop())}buscarIdsPuntosInteres(){this.ptsInteresRuta=[],this.coordenadas.forEach(t=>{const[e,n]=t,s=this.puntosInteres.find(t=>Number(t.Longitud)===e&&Number(t.Latitud)===n);s&&(this.ptsInteresRuta.find(t=>t.Id===s.Id)||this.ptsInteresRuta.push(s))})}get coordenadas(){return this.geojson.features[0].geometry.coordinates}onSubmit(t){return Object(r.a)(this,void 0,void 0,(function*(){if(isNaN(this.tiempoEstimado))this.showErrorMessage("El tiempo estimado no tiene el formato correcto");else if(Number(this.tiempoEstimado)<1)this.showErrorMessage("El tiempo estimado no puede ser cero o negativo");else if(t.valid){const{nombre:e,tiempoEst:n}=t.value;if(this.coordenadas.length<3)this.showErrorMessage("La ruta trazada es demasiado corta");else{const t=this.geometryService.buildLineString(this.coordenadas),s={Nombre:e,PuntosInteres:JSON.stringify(this.ptsInteresRuta),PuntosControl:JSON.stringify(this.puntosControl),Ruta:t,RutaText:t,TiempoEstimado:n};(yield this.recorridosService.nuevoRecorrido(s))?this.router.navigateByUrl("/recorridos"):this.showErrorMessage("Ha ocurrido un error")}}}))}showErrorMessage(t){u.a.fire({icon:"error",text:t})}getValidationClass(t){return t.untouched&&t.pristine?{}:{"is-valid":t.valid,"is-invalid":t.invalid}}}return t.\u0275fac=function(e){return new(e||t)(l.Vb(d.a),l.Vb(m.a),l.Vb(h.a),l.Vb(o.b))},t.\u0275cmp=l.Pb({type:t,selectors:[["app-nuevo"]],decls:50,vars:10,consts:[[1,"row","justify-content-center"],[1,"col-md-12"],[1,"card","shadow"],["form1","ngForm"],[1,"card-header"],[1,"col-md-4","col-sm-10"],["routerLink","/recorridos",1,"mt-2","mr-1","btn","btn-sm","btn-light","shadow-sm"],[1,"fas","fa-arrow-left"],[1,"col-md-6","col-sm-10","my-2"],[1,"row"],[1,"col"],["type","text","name","nombre","required","","placeholder","Ingresa el nombre de la ruta",1,"form-control","form-control-sm",3,"ngModel","ngClass","ngModelChange"],["name","ngModel"],[1,"invalid-feedback"],[4,"ngIf"],[1,"input-group","input-group-sm"],["type","number","name","tiempoEst",1,"form-control","form-control-sm",3,"ngModel","ngClass","ngModelChange"],["tiempoEst","ngModel"],[1,"input-group-append"],[1,"input-group-text"],[1,"col-md-2","col-sm-10"],[1,"mt-2","btn","btn-block","btn-sm","btn-success",3,"disabled","click"],[1,"card-body","py-1"],[1,"col-md-4"],["role","group",1,"btn-group","mr-3"],["title","Trazar la ruta",1,"btn","btn-sm",3,"ngClass","click"],[1,"fas","fa-route"],["title","Puntos de control",1,"btn","btn-sm",3,"ngClass","click"],[1,"fas","fa-map-marker-alt"],["title","Puntos de inter\xe9s",1,"btn","btn-sm","btn-info",3,"click"],["class","fas fa-eye",4,"ngIf"],["class","fas fa-eye-slash",4,"ngIf"],[1,"col-md-4","text-center"],[1,"badge","badge-primary","mr-2"],[1,"badge","badge-danger"],[1,"float-right"],["title","Deshacer \xfaltimo cambio",1,"btn","btn-sm","btn-outline-warning","mr-2",3,"click"],[1,"fas","fa-undo"],["title","Limpiar mapa",1,"btn","btn-sm","btn-outline-danger","mr-2",3,"click"],[1,"fas","fa-eraser"],["id","map-recorrido"],[1,"fas","fa-eye"],[1,"fas","fa-eye-slash"]],template:function(t,e){if(1&t){const t=l.bc();l.ac(0,"div",0),l.ac(1,"div",1),l.ac(2,"div",2),l.ac(3,"form",null,3),l.ac(5,"div",4),l.ac(6,"div",0),l.ac(7,"div",5),l.ac(8,"button",6),l.Wb(9,"i",7),l.Zb(),l.Zb(),l.ac(10,"div",8),l.ac(11,"div",9),l.ac(12,"div",10),l.ac(13,"input",11,12),l.ic("ngModelChange",(function(t){return e.nombre=t})),l.Zb(),l.ac(15,"div",13),l.Bc(16,p,2,0,"span",14),l.Zb(),l.Zb(),l.ac(17,"div",10),l.ac(18,"div",15),l.ac(19,"input",16,17),l.ic("ngModelChange",(function(t){return e.tiempoEstimado=t})),l.Zb(),l.ac(21,"div",18),l.ac(22,"span",19),l.Cc(23,"Minutos"),l.Zb(),l.Zb(),l.Zb(),l.Zb(),l.Zb(),l.Zb(),l.ac(24,"div",20),l.ac(25,"button",21),l.ic("click",(function(){l.yc(t);const n=l.xc(4);return e.onSubmit(n)})),l.Cc(26," Guardar "),l.Zb(),l.Zb(),l.Zb(),l.Zb(),l.Zb(),l.ac(27,"div",22),l.ac(28,"div",9),l.ac(29,"div",23),l.ac(30,"div",24),l.ac(31,"button",25),l.ic("click",(function(){return e.defineRuta=!0})),l.Wb(32,"i",26),l.Zb(),l.ac(33,"button",27),l.ic("click",(function(){return e.defineRuta=!1})),l.Wb(34,"i",28),l.Zb(),l.Zb(),l.ac(35,"button",29),l.ic("click",(function(){return e.verPtsInteres=!e.verPtsInteres,e.loadPuntosInteres()})),l.Bc(36,g,1,0,"i",30),l.Bc(37,f,1,0,"i",31),l.Zb(),l.Zb(),l.ac(38,"div",32),l.ac(39,"span",33),l.Cc(40,"Punto de inter\xe9s"),l.Zb(),l.ac(41,"span",34),l.Cc(42,"Punto de control"),l.Zb(),l.Zb(),l.ac(43,"div",23),l.ac(44,"div",35),l.ac(45,"button",36),l.ic("click",(function(){return e.deshacer()})),l.Wb(46,"i",37),l.Zb(),l.ac(47,"button",38),l.ic("click",(function(){return e.limpiar()})),l.Wb(48,"i",39),l.Zb(),l.Zb(),l.Zb(),l.Zb(),l.Wb(49,"div",40),l.Zb(),l.Zb(),l.Zb(),l.Zb()}if(2&t){const t=l.xc(4),n=l.xc(14),s=l.xc(20);l.Jb(13),l.rc("ngModel",e.nombre)("ngClass",e.getValidationClass(n)),l.Jb(3),l.rc("ngIf",null==n.errors?null:n.errors.required),l.Jb(3),l.rc("ngModel",e.tiempoEstimado)("ngClass",e.getValidationClass(s)),l.Jb(6),l.rc("disabled",t.invalid),l.Jb(6),l.rc("ngClass",e.defineRuta?"btn-primary":"btn-outline-primary"),l.Jb(2),l.rc("ngClass",e.defineRuta?"btn-outline-primary":"btn-primary"),l.Jb(3),l.rc("ngIf",!e.verPtsInteres),l.Jb(1),l.rc("ngIf",e.verPtsInteres)}},directives:[b.r,b.h,b.i,o.c,b.a,b.n,b.g,b.j,s.k,s.m,b.l],styles:["#map-recorrido[_ngcontent-%COMP%]{margin-top:10px;width:100%;height:500px}"]}),t})();var C=n("j1ZV");n.d(e,"NuevoModule",(function(){return P}));let P=(()=>{class t{}return t.\u0275mod=l.Tb({type:t}),t.\u0275inj=l.Sb({factory:function(e){return new(e||t)},imports:[[s.b,b.e,C.a,o.e.forChild([{path:"",component:v}])]]}),t})()}}]);