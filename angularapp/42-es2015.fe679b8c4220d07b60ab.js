(window.webpackJsonp=window.webpackJsonp||[]).push([[42],{"u/OU":function(t,e,n){"use strict";n.r(e);var s=n("ofXK"),o=n("tyNb"),r=n("mrSG"),i=n("4ZJM"),a=n("AytR"),u=n("PSD3"),c=n.n(u),l=n("fXoL"),d=n("bJsm"),b=n("vDOo"),m=n("VngK"),h=n("3Pt+");function p(t,e){1&t&&(l.Yb(0,"span"),l.zc(1," El nombre de la ruta es requerido "),l.Xb())}function g(t,e){1&t&&l.Ub(0,"i",41)}function f(t,e){1&t&&l.Ub(0,"i",42)}let v=(()=>{class t{constructor(t,e,n,s){this.puntosIntService=t,this.geometryService=e,this.recorridosService=n,this.router=s,this.nombre="",this.tiempoEstimado=10,this.defineRuta=!0,this.verPtsInteres=!1,this.isPuntoInteres=!1,this.isPuntoControl=!1,this.puntosControl=[],this.existsPuntoCtrl=!1,this.markersPtsInteres=[],this.markersPtsControl=[],this.puntosInteres=[],this.ptsInteresRuta=[],this.geojson={type:"FeatureCollection",features:[{type:"Feature",geometry:{type:"LineString",coordinates:[]}}]}}ngOnInit(){}ngAfterViewInit(){i.accessToken=a.a.mapboxToken,this.mapa=new i.Map({container:"map-recorrido",style:"mapbox://styles/mapbox/streets-v11",center:[-74.3451602,4.8154681],zoom:15}),this.mapa.on("load",()=>{this.mapa.addSource("line",{type:"geojson",data:this.geojson}),this.mapa.addLayer({id:"line-animation",type:"line",source:"line",layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":"#ed6498","line-width":5,"line-opacity":.8}})}),this.mapa.on("click",t=>{const{lng:e,lat:n}=t.lngLat;this.defineRuta?this.isPuntoInteres||this.isPuntoControl?this.isPuntoInteres=this.isPuntoControl=!1:this.agregarCoordenada(e,n):this.existsPuntoCtrl||this.isPuntoInteres?this.existsPuntoCtrl=this.isPuntoInteres=!1:this.nuevoPuntoControl(e,n)}),this.mapa.addControl(new i.NavigationControl),this.mapa.addControl(new i.FullscreenControl)}nuevoPuntoControl(t,e){c.a.fire({title:"Nuevo punto de control",text:"Ingresa el nombre del punto",input:"text",showCancelButton:!0,confirmButtonText:"Agregar",cancelButtonText:"Cancelar",cancelButtonColor:"#d33",inputValidator:t=>{if(!t)return"Necesitas escribir un nombre!"}}).then(n=>{if(n.value){this.puntosControl.push({longitud:t,latitud:e,nombre:n.value});const s=new i.Popup({offset:25}).setText(n.value),o=new i.Marker({color:"#d33"}).setPopup(s).setLngLat([t,e]).addTo(this.mapa);this.markersPtsControl.push(o),o._element.addEventListener("click",()=>{this.defineRuta?(this.isPuntoControl=!0,this.agregarCoordenada(t,e)):this.existsPuntoCtrl=!0})}})}loadPuntosInteres(){return Object(r.a)(this,void 0,void 0,(function*(){this.verPtsInteres?this.puntosInteres=yield this.puntosIntService.getPuntosInteres():(this.eliminarMarkers(),this.puntosInteres=[]),this.mostrarPuntosInteres()}))}mostrarPuntosInteres(){this.puntosInteres.forEach(t=>{const e=new i.Popup({offset:25}).setText(t.Descripcion),n=(new i.Marker).setPopup(e).setLngLat([t.Longitud,t.Latitud]).addTo(this.mapa);this.markersPtsInteres.push(n),n._element.addEventListener("click",()=>{this.defineRuta&&this.agregarCoordenada(t.Longitud,t.Latitud),this.isPuntoInteres=!0})})}eliminarMarkers(){this.markersPtsInteres.forEach((t,e)=>{this.markersPtsInteres[e].remove()})}agregarCoordenada(t,e){this.geojson.features[0].geometry.coordinates.push([Number(t),Number(e)]),this.mapa.getSource("line").setData(this.geojson),this.buscarIdsPuntosInteres()}limpiar(){this.defineRuta?(this.geojson.features[0].geometry.coordinates=[],this.ptsInteresRuta=[],this.mapa.getSource("line").setData(this.geojson)):(this.puntosControl=[],this.markersPtsControl.forEach((t,e)=>{this.markersPtsControl[e].remove()}),this.markersPtsControl=[])}deshacer(){this.defineRuta?(this.geojson.features[0].geometry.coordinates.pop(),this.mapa.getSource("line").setData(this.geojson),this.buscarIdsPuntosInteres()):(this.puntosControl.pop(),this.markersPtsControl.length>0&&this.markersPtsControl[this.markersPtsControl.length-1].remove(),this.markersPtsControl.pop())}buscarIdsPuntosInteres(){this.ptsInteresRuta=[],this.coordenadas.forEach(t=>{const[e,n]=t,s=this.puntosInteres.find(t=>Number(t.Longitud)===e&&Number(t.Latitud)===n);s&&(this.ptsInteresRuta.find(t=>t.Id===s.Id)||this.ptsInteresRuta.push(s))})}get coordenadas(){return this.geojson.features[0].geometry.coordinates}onSubmit(t){return Object(r.a)(this,void 0,void 0,(function*(){if(t.valid){const{nombre:e,tiempoEst:n}=t.value;if(this.coordenadas.length<3)this.showErrorMessage("La ruta trazada es demasiado corta");else{const t=this.geometryService.buildLineString(this.coordenadas),s={Nombre:e,PuntosInteres:JSON.stringify(this.ptsInteresRuta),PuntosControl:JSON.stringify(this.puntosControl),Ruta:t,RutaText:t,TiempoEstimado:n};(yield this.recorridosService.nuevoRecorrido(s))?this.router.navigateByUrl("/recorridos"):this.showErrorMessage("Ha ocurrido un error")}}}))}showErrorMessage(t){c.a.fire({icon:"error",text:t})}getValidationClass(t){return t.untouched&&t.pristine?{}:{"is-valid":t.valid,"is-invalid":t.invalid}}}return t.\u0275fac=function(e){return new(e||t)(l.Tb(d.a),l.Tb(b.a),l.Tb(m.a),l.Tb(o.b))},t.\u0275cmp=l.Nb({type:t,selectors:[["app-nuevo"]],decls:50,vars:10,consts:[[1,"row","justify-content-center"],[1,"col-md-12"],[1,"card","shadow"],["form1","ngForm"],[1,"card-header"],[1,"col-md-4","col-sm-10"],["routerLink","/recorridos",1,"mt-2","mr-1","btn","btn-sm","btn-light","shadow-sm"],[1,"fas","fa-arrow-left"],[1,"col-md-6","col-sm-10","my-2"],[1,"row"],[1,"col"],["type","text","name","nombre","required","","placeholder","Ingresa el nombre de la ruta",1,"form-control","form-control-sm",3,"ngModel","ngClass","ngModelChange"],["name","ngModel"],[1,"invalid-feedback"],[4,"ngIf"],[1,"input-group","input-group-sm"],["type","number","name","tiempoEst",1,"form-control","form-control-sm",3,"ngModel","ngClass","ngModelChange"],["tiempoEst","ngModel"],[1,"input-group-append"],[1,"input-group-text"],[1,"col-md-2","col-sm-10"],[1,"mt-2","btn","btn-block","btn-sm","btn-success",3,"disabled","click"],[1,"card-body","py-1"],[1,"col-md-4"],["role","group",1,"btn-group","mr-3"],["title","Trazar la ruta",1,"btn","btn-sm",3,"ngClass","click"],[1,"fas","fa-route"],["title","Puntos de control",1,"btn","btn-sm",3,"ngClass","click"],[1,"fas","fa-map-marker-alt"],["title","Puntos de inter\xe9s",1,"btn","btn-sm","btn-info",3,"click"],["class","fas fa-eye",4,"ngIf"],["class","fas fa-eye-slash",4,"ngIf"],[1,"col-md-4","text-center"],[1,"badge","badge-primary","mr-2"],[1,"badge","badge-danger"],[1,"float-right"],["title","Deshacer \xfaltimo cambio",1,"btn","btn-sm","btn-outline-warning","mr-2",3,"click"],[1,"fas","fa-undo"],["title","Limpiar mapa",1,"btn","btn-sm","btn-outline-danger","mr-2",3,"click"],[1,"fas","fa-eraser"],["id","map-recorrido"],[1,"fas","fa-eye"],[1,"fas","fa-eye-slash"]],template:function(t,e){if(1&t){const t=l.Zb();l.Yb(0,"div",0),l.Yb(1,"div",1),l.Yb(2,"div",2),l.Yb(3,"form",null,3),l.Yb(5,"div",4),l.Yb(6,"div",0),l.Yb(7,"div",5),l.Yb(8,"button",6),l.Ub(9,"i",7),l.Xb(),l.Xb(),l.Yb(10,"div",8),l.Yb(11,"div",9),l.Yb(12,"div",10),l.Yb(13,"input",11,12),l.gc("ngModelChange",(function(t){return e.nombre=t})),l.Xb(),l.Yb(15,"div",13),l.xc(16,p,2,0,"span",14),l.Xb(),l.Xb(),l.Yb(17,"div",10),l.Yb(18,"div",15),l.Yb(19,"input",16,17),l.gc("ngModelChange",(function(t){return e.tiempoEstimado=t})),l.Xb(),l.Yb(21,"div",18),l.Yb(22,"span",19),l.zc(23,"Minutos"),l.Xb(),l.Xb(),l.Xb(),l.Xb(),l.Xb(),l.Xb(),l.Yb(24,"div",20),l.Yb(25,"button",21),l.gc("click",(function(){l.uc(t);const n=l.tc(4);return e.onSubmit(n)})),l.zc(26," Guardar "),l.Xb(),l.Xb(),l.Xb(),l.Xb(),l.Xb(),l.Yb(27,"div",22),l.Yb(28,"div",9),l.Yb(29,"div",23),l.Yb(30,"div",24),l.Yb(31,"button",25),l.gc("click",(function(){return e.defineRuta=!0})),l.Ub(32,"i",26),l.Xb(),l.Yb(33,"button",27),l.gc("click",(function(){return e.defineRuta=!1})),l.Ub(34,"i",28),l.Xb(),l.Xb(),l.Yb(35,"button",29),l.gc("click",(function(){return e.verPtsInteres=!e.verPtsInteres,e.loadPuntosInteres()})),l.xc(36,g,1,0,"i",30),l.xc(37,f,1,0,"i",31),l.Xb(),l.Xb(),l.Yb(38,"div",32),l.Yb(39,"span",33),l.zc(40,"Punto de inter\xe9s"),l.Xb(),l.Yb(41,"span",34),l.zc(42,"Punto de control"),l.Xb(),l.Xb(),l.Yb(43,"div",23),l.Yb(44,"div",35),l.Yb(45,"button",36),l.gc("click",(function(){return e.deshacer()})),l.Ub(46,"i",37),l.Xb(),l.Yb(47,"button",38),l.gc("click",(function(){return e.limpiar()})),l.Ub(48,"i",39),l.Xb(),l.Xb(),l.Xb(),l.Xb(),l.Ub(49,"div",40),l.Xb(),l.Xb(),l.Xb(),l.Xb()}if(2&t){const t=l.tc(4),n=l.tc(14),s=l.tc(20);l.Hb(13),l.mc("ngModel",e.nombre)("ngClass",e.getValidationClass(n)),l.Hb(3),l.mc("ngIf",null==n.errors?null:n.errors.required),l.Hb(3),l.mc("ngModel",e.tiempoEstimado)("ngClass",e.getValidationClass(s)),l.Hb(6),l.mc("disabled",t.invalid),l.Hb(6),l.mc("ngClass",e.defineRuta?"btn-primary":"btn-outline-primary"),l.Hb(2),l.mc("ngClass",e.defineRuta?"btn-outline-primary":"btn-primary"),l.Hb(3),l.mc("ngIf",!e.verPtsInteres),l.Hb(1),l.mc("ngIf",e.verPtsInteres)}},directives:[h.s,h.h,h.i,o.c,h.a,h.o,h.g,h.j,s.i,s.k,h.l],styles:["#map-recorrido[_ngcontent-%COMP%]{margin-top:10px;width:100%;height:500px}"]}),t})();var P=n("j1ZV");n.d(e,"NuevoModule",(function(){return C}));let C=(()=>{class t{}return t.\u0275mod=l.Rb({type:t}),t.\u0275inj=l.Qb({factory:function(e){return new(e||t)},imports:[[s.b,h.e,P.a,o.e.forChild([{path:"",component:v}])]]}),t})()}}]);